<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{FORMULA_NAME}} - Homebrew Den</title>
  <meta name="description" content="Install {{FORMULA_NAME}} from the Homebrew Den tap.">
  <link rel="icon" type="image/svg+xml" href="../../favicon.svg">
  <link rel="stylesheet" href="../../output.css">
</head>
<body class="font-sans leading-relaxed">
  <!-- Nav -->
  <nav class="sticky top-0 z-100 bg-[var(--bg-alt)] border-b border-[var(--card-border)] backdrop-blur-md transition-[background,border-color] duration-200 ease-in-out">
    <div class="max-w-[1080px] mx-auto px-6 h-15 flex items-center justify-between">
      <a href="../../" class="flex items-center gap-2.5 font-bold text-lg text-[var(--text)] no-underline">
        <svg class="w-7 h-7 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M17 8h1a4 4 0 1 1 0 8h-1"/>
          <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/>
          <line x1="6" y1="2" x2="6" y2="4"/>
          <line x1="10" y1="2" x2="10" y2="4"/>
          <line x1="14" y1="2" x2="14" y2="4"/>
        </svg>
        Homebrew Den
      </a>
      <div class="flex items-center gap-2">
        <button class="flex items-center gap-2 h-9 px-3 border border-[var(--card-border)] rounded-sm bg-transparent text-[var(--text-muted)] cursor-pointer font-sans text-[0.85rem] transition-all duration-200 ease-in-out hover:text-accent hover:border-accent hover:bg-accent-subtle max-sm:w-9 max-sm:px-0 max-sm:justify-center" id="search-trigger" aria-label="Search packages">
          <svg class="w-4 h-4 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
          <span class="max-sm:hidden">Search packages...</span>
          <kbd class="font-sans text-[0.7rem] px-1.5 py-0.5 border border-[var(--card-border)] rounded-[3px] bg-[var(--code-bg)] text-[var(--text-muted)] leading-none max-sm:hidden" id="search-kbd"></kbd>
        </button>
        <button class="flex items-center justify-center w-9 h-9 border border-[var(--card-border)] rounded-sm bg-transparent text-[var(--text-muted)] cursor-pointer transition-all duration-200 ease-in-out hover:text-accent hover:border-accent hover:bg-accent-subtle" id="theme-toggle" aria-label="Toggle theme">
          <svg class="icon-sun w-[18px] h-[18px]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
          <svg class="icon-moon w-[18px] h-[18px]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        </button>
        <a href="https://github.com/mrdemonwolf/homebrew-den" class="flex items-center justify-center w-9 h-9 border border-[var(--card-border)] rounded-sm bg-transparent text-[var(--text-muted)] cursor-pointer transition-all duration-200 ease-in-out hover:text-accent hover:border-accent hover:bg-accent-subtle" aria-label="View on GitHub" target="_blank" rel="noopener noreferrer">
          <svg class="w-[18px] h-[18px]" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/>
          </svg>
        </a>
      </div>
    </div>
  </nav>

  <!-- Search Modal -->
  <div class="fixed inset-0 z-200 flex items-start justify-center pt-[15vh] bg-[var(--overlay-bg)] backdrop-blur-sm animate-fade-in hidden" id="search-overlay">
    <div class="w-full max-w-[560px] bg-[var(--card-bg)] border border-[var(--card-border)] rounded-lg shadow-[0_16px_48px_rgba(0,0,0,0.3)] overflow-hidden animate-slide-up max-sm:mx-4">
      <div class="flex items-center gap-3 p-4 border-b border-[var(--card-border)]">
        <svg class="w-5 h-5 text-[var(--text-muted)] shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input type="text" class="flex-1 border-none outline-none bg-transparent text-[var(--text)] font-sans text-base placeholder:text-[var(--text-muted)]" id="search-input" placeholder="Search formulae and casks..." autocomplete="off" spellcheck="false">
        <kbd class="font-sans text-[0.65rem] px-1.5 py-[3px] border border-[var(--card-border)] rounded-[3px] bg-[var(--code-bg)] text-[var(--text-muted)] leading-none uppercase tracking-wide">esc</kbd>
      </div>
      <div class="max-h-[340px] overflow-y-auto" id="search-results">
        <div class="py-8 px-4 text-center text-[var(--text-muted)] text-[0.9rem]">Type to search packages...</div>
      </div>
      <div class="flex items-center gap-4 px-4 py-2.5 border-t border-[var(--card-border)] bg-[var(--code-bg)] text-[0.75rem] text-[var(--text-muted)]">
        <span><kbd class="inline-block font-sans text-[0.65rem] px-[5px] py-[1px] border border-[var(--card-border)] rounded-[3px] bg-[var(--card-bg)] text-[var(--text-muted)] mx-0.5">&uarr;</kbd><kbd class="inline-block font-sans text-[0.65rem] px-[5px] py-[1px] border border-[var(--card-border)] rounded-[3px] bg-[var(--card-bg)] text-[var(--text-muted)] mx-0.5">&darr;</kbd> navigate</span>
        <span><kbd class="inline-block font-sans text-[0.65rem] px-[5px] py-[1px] border border-[var(--card-border)] rounded-[3px] bg-[var(--card-bg)] text-[var(--text-muted)] mx-0.5">&crarr;</kbd> open</span>
        <span><kbd class="inline-block font-sans text-[0.65rem] px-[5px] py-[1px] border border-[var(--card-border)] rounded-[3px] bg-[var(--card-bg)] text-[var(--text-muted)] mx-0.5">esc</kbd> close</span>
      </div>
    </div>
  </div>

  <!-- Breadcrumb -->
  <div class="border-b border-[var(--card-border)] bg-[var(--bg-alt)] transition-all duration-200 ease-in-out">
    <div class="max-w-[1080px] mx-auto px-6 py-3 text-[0.85rem] flex items-center gap-1.5">
      <a href="../../" class="text-[var(--text-muted)] hover:text-accent">Home</a>
      <span class="text-[var(--text-muted)]">/</span>
      <a href="../../#formulae-section" class="text-[var(--text-muted)] hover:text-accent">Formulae</a>
      <span class="text-[var(--text-muted)]">/</span>
      <span class="text-[var(--text)] font-semibold" id="breadcrumb-name">{{FORMULA_NAME}}</span>
    </div>
  </div>

  <!-- Formula Detail -->
  <div class="max-w-[1080px] mx-auto px-6 max-sm:px-4">
    <!-- Mobile: horizontal scrollable strip -->
    <nav class="sticky top-[60px] z-50 -mx-6 max-sm:-mx-4 px-6 max-sm:px-4 py-2 bg-[var(--bg)] border-b border-[var(--card-border)]
                overflow-x-auto whitespace-nowrap flex gap-2 [scrollbar-width:none] md:hidden"
         id="sidebar-mobile" aria-label="Page sections">
      <a href="#install-section" class="sidebar-link text-[0.8rem] font-semibold px-3 py-1.5 rounded-md
         text-[var(--text-muted)] hover:text-accent transition-colors shrink-0" data-section="install-section">Install</a>
      <a href="#details-section" class="sidebar-link text-[0.8rem] font-semibold px-3 py-1.5 rounded-md
         text-[var(--text-muted)] hover:text-accent transition-colors shrink-0" data-section="details-section">Details</a>
      <a href="#caveats-section" class="sidebar-link text-[0.8rem] font-semibold px-3 py-1.5 rounded-md
         text-[var(--text-muted)] hover:text-accent transition-colors shrink-0 hidden" data-section="caveats-section">Caveats</a>
      <a href="#versions-section" class="sidebar-link text-[0.8rem] font-semibold px-3 py-1.5 rounded-md
         text-[var(--text-muted)] hover:text-accent transition-colors shrink-0 hidden" data-section="versions-section">Versions</a>
    </nav>

    <div class="flex gap-8 pt-12 pb-16 max-md:block max-md:py-10">
      <!-- Desktop: sticky sidebar -->
      <aside class="w-[180px] shrink-0 max-md:hidden">
        <nav class="sticky top-[80px]" aria-label="Page sections">
          <ul class="list-none p-0 m-0 space-y-1">
            <li><a href="#install-section" class="sidebar-link block text-[0.85rem] font-medium py-1.5 px-3
                rounded-md text-[var(--text-muted)] hover:text-accent hover:bg-accent-subtle
                transition-all border-l-2 border-transparent" data-section="install-section">Install</a></li>
            <li><a href="#details-section" class="sidebar-link block text-[0.85rem] font-medium py-1.5 px-3
                rounded-md text-[var(--text-muted)] hover:text-accent hover:bg-accent-subtle
                transition-all border-l-2 border-transparent" data-section="details-section">Details</a></li>
            <li class="hidden" id="sidebar-caveats"><a href="#caveats-section" class="sidebar-link block text-[0.85rem] font-medium py-1.5 px-3
                rounded-md text-[var(--text-muted)] hover:text-accent hover:bg-accent-subtle
                transition-all border-l-2 border-transparent" data-section="caveats-section">Caveats</a></li>
            <li class="hidden" id="sidebar-versions"><a href="#versions-section" class="sidebar-link block text-[0.85rem] font-medium py-1.5 px-3
                rounded-md text-[var(--text-muted)] hover:text-accent hover:bg-accent-subtle
                transition-all border-l-2 border-transparent" data-section="versions-section">Versions</a></li>
          </ul>
        </nav>
      </aside>

      <!-- Main content -->
      <main class="flex-1 min-w-0">
        <div class="mb-8">
          <div class="flex items-center gap-3 mb-2 flex-wrap">
            <h1 class="text-[2rem] font-extrabold tracking-tight max-sm:text-[1.5rem]" id="formula-name"></h1>
            <span class="font-mono text-[0.85rem] bg-accent-subtle text-accent px-2 py-0.5 rounded-xl whitespace-nowrap" id="formula-version"></span>
            <span id="formula-stability-badge"></span>
          </div>
          <p class="text-[var(--text-muted)] text-[1.1rem]" id="formula-desc"></p>
        </div>

        <!-- Install Command -->
        <div class="bg-[var(--card-bg)] border border-[var(--card-border)] rounded-md p-6 mb-5 transition-all duration-200 ease-in-out scroll-mt-24" id="install-section">
          <h2 class="text-[0.8rem] font-semibold mb-4 uppercase tracking-widest text-[var(--text-muted)]">Install</h2>
          <div class="inline-flex items-center gap-3 bg-[var(--code-bg)] border border-[var(--code-border)] rounded-md px-5 py-3.5 font-mono text-[0.95rem] text-[var(--text)] w-full shadow-none">
            <code id="install-command"></code>
            <button class="copy-btn flex items-center justify-center w-8 h-8 border-none rounded-sm bg-accent text-white cursor-pointer transition-all duration-200 ease-in-out hover:bg-accent-hover hover:scale-105 shrink-0 ml-auto" onclick="copyText('install-command', this)" aria-label="Copy install command">
              <svg class="icon-copy w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
              <svg class="icon-check w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Details -->
        <div class="bg-[var(--card-bg)] border border-[var(--card-border)] rounded-md p-6 mb-5 transition-all duration-200 ease-in-out scroll-mt-24" id="details-section">
          <h2 class="text-[0.8rem] font-semibold mb-4 uppercase tracking-widest text-[var(--text-muted)]">Details</h2>
          <dl class="grid gap-0">
            <div class="flex items-baseline py-2.5 border-b border-[var(--card-border)] first:pt-0 last:border-b-0 last:pb-0 max-sm:flex-col max-sm:gap-0.5">
              <dt class="w-[120px] shrink-0 text-[0.85rem] font-semibold text-[var(--text-muted)] max-sm:w-auto">Homepage</dt>
              <dd class="text-[0.9rem]"><a id="formula-homepage" href="" target="_blank" rel="noopener noreferrer"></a></dd>
            </div>
            <div class="flex items-baseline py-2.5 border-b border-[var(--card-border)] first:pt-0 last:border-b-0 last:pb-0 max-sm:flex-col max-sm:gap-0.5">
              <dt class="w-[120px] shrink-0 text-[0.85rem] font-semibold text-[var(--text-muted)] max-sm:w-auto">License</dt>
              <dd class="text-[0.9rem]" id="formula-license"></dd>
            </div>
            <div class="flex items-baseline py-2.5 border-b border-[var(--card-border)] first:pt-0 last:border-b-0 last:pb-0 max-sm:flex-col max-sm:gap-0.5">
              <dt class="w-[120px] shrink-0 text-[0.85rem] font-semibold text-[var(--text-muted)] max-sm:w-auto">Version</dt>
              <dd class="text-[0.9rem]" id="formula-version-detail"></dd>
            </div>
            <div class="flex items-baseline py-2.5 border-b border-[var(--card-border)] first:pt-0 last:border-b-0 last:pb-0 max-sm:flex-col max-sm:gap-0.5" id="stability-row">
              <dt class="w-[120px] shrink-0 text-[0.85rem] font-semibold text-[var(--text-muted)] max-sm:w-auto">Stability</dt>
              <dd class="text-[0.9rem]" id="formula-stability-detail"></dd>
            </div>
          </dl>
        </div>

        <!-- Caveats -->
        <div class="bg-[var(--card-bg)] border border-[var(--card-border)] rounded-md p-6 mb-5 transition-all duration-200 ease-in-out hidden scroll-mt-24" id="caveats-section">
          <h2 class="text-[0.8rem] font-semibold mb-4 uppercase tracking-widest text-[var(--text-muted)]">Caveats</h2>
          <pre class="bg-[var(--code-bg)] border border-[var(--code-border)] rounded-sm p-4 font-mono text-[0.85rem] text-[var(--text)] whitespace-pre-wrap break-words leading-normal overflow-x-auto" id="formula-caveats"></pre>
        </div>

        <!-- Version History -->
        <div class="bg-[var(--card-bg)] border border-[var(--card-border)] rounded-md p-6 mb-5 transition-all duration-200 ease-in-out hidden scroll-mt-24" id="versions-section">
          <h2 class="text-[0.8rem] font-semibold mb-4 uppercase tracking-widest text-[var(--text-muted)]">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 6px;">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            Version History
          </h2>
          <div class="table-wrap bg-[var(--card-bg)] border border-[var(--card-border)] rounded-md overflow-hidden shadow-[var(--shadow)] transition-all duration-200 ease-in-out max-sm:rounded-none max-sm:border-x-0">
            <table>
              <thead>
                <tr>
                  <th>Version</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="versions-body"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Footer -->
  <footer class="border-t border-[var(--card-border)] py-8 px-6 text-center text-[var(--text-muted)] text-[0.85rem] transition-[border-color] duration-200 ease-in-out">
    <div class="max-w-[1080px] mx-auto flex items-center justify-center gap-2 flex-wrap">
      <span>MIT License</span>
      <span class="text-[var(--card-border)]">&middot;</span>
      <span>&copy; 2026 <a href="https://www.mrdemonwolf.com" class="text-[var(--text-muted)] transition-colors duration-200 ease-in-out hover:text-accent" target="_blank" rel="noopener noreferrer">MrDemonWolf, Inc.</a></span>
      <span class="text-[var(--card-border)]">&middot;</span>
      <a href="https://github.com/mrdemonwolf/homebrew-den" class="text-[var(--text-muted)] transition-colors duration-200 ease-in-out hover:text-accent" target="_blank" rel="noopener noreferrer">GitHub</a>
    </div>
  </footer>

  <script>
    // --- Formula data injected at build time ---
    const formula = {{FORMULA_JSON}};
    const data = {{PACKAGES_JSON}};

    // --- Badge helpers ---
    const BADGE = 'inline-block font-sans text-[0.7rem] font-bold uppercase tracking-[0.04em] px-2 py-0.5 rounded-xl whitespace-nowrap align-middle';
    const BADGE_COLORS = {
      alpha: 'bg-[rgba(245,158,11,0.15)] text-[#f59e0b]',
      beta: 'bg-[rgba(168,85,247,0.15)] text-[#a855f7]',
      rc: 'bg-[rgba(59,130,246,0.15)] text-[#3b82f6]',
      'pre-release': 'bg-[rgba(249,115,22,0.15)] text-[#f97316]',
      stable: 'bg-[rgba(34,197,94,0.15)] text-[#22c55e]',
      current: 'bg-accent-subtle text-accent'
    };

    // --- Populate page ---
    document.getElementById('formula-name').textContent = formula.name;
    document.getElementById('formula-version').textContent = 'v' + formula.version;
    document.getElementById('formula-desc').textContent = formula.desc;
    document.getElementById('install-command').textContent = 'brew install ' + formula.name;
    document.getElementById('formula-homepage').textContent = formula.homepage;
    document.getElementById('formula-homepage').href = formula.homepage;
    document.getElementById('formula-license').textContent = formula.license || 'N/A';
    document.getElementById('formula-version-detail').textContent = formula.version;

    // Stability badge
    const stabilityLabels = { alpha: 'Alpha', beta: 'Beta', rc: 'Release Candidate', 'pre-release': 'Pre-release', stable: 'Stable' };
    const stability = formula.stability || 'stable';
    const stabilityLabel = stabilityLabels[stability] || stability;

    if (stability !== 'stable') {
      document.getElementById('formula-stability-badge').innerHTML =
        '<span class="' + BADGE + ' ' + (BADGE_COLORS[stability] || '') + '">' + stabilityLabel + '</span>';
      document.getElementById('formula-stability-detail').innerHTML =
        '<span class="' + BADGE + ' ' + (BADGE_COLORS[stability] || '') + '">' + stabilityLabel + '</span>' +
        '<span class="text-[0.8rem] text-[var(--text-muted)]"> &mdash; This version is not yet considered stable.</span>';
    } else {
      document.getElementById('formula-stability-detail').innerHTML =
        '<span class="' + BADGE + ' ' + BADGE_COLORS.stable + '">Stable</span>';
    }

    // Caveats
    if (formula.caveats) {
      document.getElementById('caveats-section').classList.remove('hidden');
      document.getElementById('formula-caveats').textContent = formula.caveats;
      // Show sidebar links for caveats
      document.getElementById('sidebar-caveats').classList.remove('hidden');
      document.querySelectorAll('#sidebar-mobile .sidebar-link[data-section="caveats-section"]').forEach(el => el.classList.remove('hidden'));
    }

    // Version history
    if (formula.versions && formula.versions.length > 0) {
      document.getElementById('versions-section').classList.remove('hidden');
      // Show sidebar links for versions
      document.getElementById('sidebar-versions').classList.remove('hidden');
      document.querySelectorAll('#sidebar-mobile .sidebar-link[data-section="versions-section"]').forEach(el => el.classList.remove('hidden'));

      const vtbody = document.getElementById('versions-body');
      vtbody.innerHTML = formula.versions.map(v => {
        const isCurrent = v.version === formula.version;
        const statusBadge = v.prerelease
          ? '<span class="' + BADGE + ' ' + BADGE_COLORS['pre-release'] + '">Pre-release</span>'
          : '<span class="' + BADGE + ' ' + BADGE_COLORS.stable + '">Stable</span>';
        const currentTag = isCurrent ? ' <span class="' + BADGE + ' ' + BADGE_COLORS.current + '">Current</span>' : '';
        return '<tr' + (isCurrent ? ' class="bg-accent-subtle"' : '') + '>' +
          '<td data-label="Version"><span class="font-mono text-[0.8rem] bg-accent-subtle text-accent px-2 py-0.5 rounded-xl whitespace-nowrap">v' + v.version + '</span>' + currentTag + '</td>' +
          '<td data-label="Date">' + v.date + '</td>' +
          '<td data-label="Status">' + statusBadge + '</td>' +
          '<td data-label=""><a href="' + v.url + '" target="_blank" rel="noopener noreferrer" class="text-accent no-underline text-[0.85rem] hover:underline">Release notes</a></td>' +
          '</tr>';
      }).join('');
    }

    // --- Sidebar: Active Section Tracking ---
    const DESKTOP_ACTIVE = ['!text-accent', '!border-l-accent', 'bg-accent-subtle'];
    const DESKTOP_INACTIVE = ['text-[var(--text-muted)]', 'border-transparent'];
    const MOBILE_ACTIVE = ['!text-accent', 'bg-accent-subtle'];
    const MOBILE_INACTIVE = ['text-[var(--text-muted)]'];

    function setActiveSection(sectionId) {
      // Desktop sidebar
      document.querySelectorAll('aside .sidebar-link').forEach(link => {
        if (link.dataset.section === sectionId) {
          link.classList.add(...DESKTOP_ACTIVE);
          link.classList.remove(...DESKTOP_INACTIVE);
        } else {
          link.classList.remove(...DESKTOP_ACTIVE);
          link.classList.add(...DESKTOP_INACTIVE);
        }
      });
      // Mobile strip
      const mobileNav = document.getElementById('sidebar-mobile');
      mobileNav.querySelectorAll('.sidebar-link').forEach(link => {
        if (link.dataset.section === sectionId) {
          link.classList.add(...MOBILE_ACTIVE);
          link.classList.remove(...MOBILE_INACTIVE);
          // Auto-scroll to keep active link centered
          link.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        } else {
          link.classList.remove(...MOBILE_ACTIVE);
          link.classList.add(...MOBILE_INACTIVE);
        }
      });
    }

    // IntersectionObserver for active section detection
    function setupObserver() {
      const sections = document.querySelectorAll('[id$="-section"]:not(.hidden)');
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            setActiveSection(entry.target.id);
          }
        });
      }, { rootMargin: '-80px 0px -35% 0px', threshold: 0 });

      sections.forEach(section => observer.observe(section));
      return observer;
    }

    let sectionObserver = setupObserver();

    // Re-observe when hidden cards become visible (MutationObserver)
    const mutationObserver = new MutationObserver(() => {
      sectionObserver.disconnect();
      sectionObserver = setupObserver();
    });
    document.querySelectorAll('[id$="-section"]').forEach(el => {
      mutationObserver.observe(el, { attributes: true, attributeFilter: ['class'] });
    });

    // --- Copy function ---
    function copyText(elementId, btn) {
      const text = document.getElementById(elementId).textContent;
      navigator.clipboard.writeText(text).then(() => {
        btn.classList.add('!bg-[#22c55e]');
        btn.querySelector('.icon-copy').style.display = 'none';
        btn.querySelector('.icon-check').style.display = 'block';
        setTimeout(() => {
          btn.classList.remove('!bg-[#22c55e]');
          btn.querySelector('.icon-copy').style.display = '';
          btn.querySelector('.icon-check').style.display = 'none';
        }, 2000);
      });
    }

    // --- Theme toggle ---
    const themeToggle = document.getElementById('theme-toggle');
    const html = document.documentElement;

    function setTheme(theme) {
      if (theme === 'dark') {
        html.classList.add('dark');
      } else {
        html.classList.remove('dark');
      }
      localStorage.setItem('theme', theme);
      const sun = themeToggle.querySelector('.icon-sun');
      const moon = themeToggle.querySelector('.icon-moon');
      if (theme === 'dark') {
        sun.style.display = 'block';
        moon.style.display = 'none';
      } else {
        sun.style.display = 'none';
        moon.style.display = 'block';
      }
    }

    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      setTheme(savedTheme);
    } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
      setTheme('light');
    } else {
      setTheme('dark');
    }

    themeToggle.addEventListener('click', () => {
      const current = html.classList.contains('dark') ? 'dark' : 'light';
      setTheme(current === 'dark' ? 'light' : 'dark');
    });

    // --- Cmd+K Search ---
    const searchOverlay = document.getElementById('search-overlay');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const searchTrigger = document.getElementById('search-trigger');
    let activeIndex = -1;

    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
    document.getElementById('search-kbd').textContent = isMac ? '\u2318K' : 'Ctrl+K';

    function buildSearchIndex() {
      const items = [];
      (data.formulae || []).forEach(f => {
        items.push({ name: f.name, desc: f.desc, version: f.version, type: 'Formula', href: '../../formulae/' + f.name + '/' });
      });
      (data.casks || []).forEach(c => {
        items.push({ name: c.name, desc: c.desc, version: c.version, type: 'Cask', href: c.homepage });
      });
      return items;
    }

    const searchIndex = buildSearchIndex();
    const SEARCH_ACTIVE = ['bg-accent-subtle', 'border-l-[3px]', 'border-l-accent', '!pl-[13px]'];

    function openSearch() {
      searchOverlay.classList.remove('hidden');
      searchInput.value = '';
      searchInput.focus();
      activeIndex = -1;
      renderSearchResults('');
      document.body.style.overflow = 'hidden';
    }

    function closeSearch() {
      searchOverlay.classList.add('hidden');
      document.body.style.overflow = '';
    }

    function renderSearchResults(query) {
      if (!query.trim()) {
        searchResults.innerHTML = '<div class="py-8 px-4 text-center text-[var(--text-muted)] text-[0.9rem]">Type to search packages...</div>';
        activeIndex = -1;
        return;
      }

      const q = query.toLowerCase();
      const matches = searchIndex.filter(item =>
        item.name.toLowerCase().includes(q) ||
        item.desc.toLowerCase().includes(q)
      );

      if (matches.length === 0) {
        searchResults.innerHTML = '<div class="py-8 px-4 text-center text-[var(--text-muted)] text-[0.9rem]">No packages found.</div>';
        activeIndex = -1;
        return;
      }

      const activeClasses = SEARCH_ACTIVE.join(' ');
      searchResults.innerHTML = matches.map((item, i) => `
        <a href="${item.href}" class="search-result flex items-center justify-between px-4 py-3 text-[var(--text)] no-underline border-b border-[var(--card-border)] transition-[background] duration-200 ease-in-out cursor-pointer last:border-b-0 hover:bg-accent-subtle${i === activeIndex ? ' ' + activeClasses : ''}" data-index="${i}">
          <div class="flex flex-col gap-0.5 min-w-0">
            <span class="font-semibold text-accent text-[0.95rem]">${item.name}</span>
            <span class="text-[var(--text-muted)] text-[0.8rem] whitespace-nowrap overflow-hidden text-ellipsis">${item.desc}</span>
          </div>
          <div class="flex items-center gap-2 shrink-0 ml-4">
            <span class="text-[0.7rem] font-semibold uppercase tracking-wide px-2 py-0.5 rounded-xl bg-accent-subtle text-accent">${item.type}</span>
            <span class="font-mono text-[0.75rem] text-[var(--text-muted)]">v${item.version}</span>
          </div>
        </a>
      `).join('');
    }

    function navigateResults(direction) {
      const items = searchResults.querySelectorAll('.search-result');
      if (items.length === 0) return;
      activeIndex += direction;
      if (activeIndex < 0) activeIndex = items.length - 1;
      if (activeIndex >= items.length) activeIndex = 0;
      items.forEach((el, i) => {
        if (i === activeIndex) {
          el.classList.add(...SEARCH_ACTIVE);
        } else {
          el.classList.remove(...SEARCH_ACTIVE);
        }
      });
      items[activeIndex].scrollIntoView({ block: 'nearest' });
    }

    function selectResult() {
      const items = searchResults.querySelectorAll('.search-result');
      if (activeIndex >= 0 && activeIndex < items.length) items[activeIndex].click();
    }

    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        searchOverlay.classList.contains('hidden') ? openSearch() : closeSearch();
      }
      if (e.key === 'Escape' && !searchOverlay.classList.contains('hidden')) closeSearch();
    });

    searchInput.addEventListener('input', () => { activeIndex = -1; renderSearchResults(searchInput.value); });
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowDown') { e.preventDefault(); navigateResults(1); }
      if (e.key === 'ArrowUp') { e.preventDefault(); navigateResults(-1); }
      if (e.key === 'Enter') { e.preventDefault(); selectResult(); }
    });

    searchOverlay.addEventListener('click', (e) => { if (e.target === searchOverlay) closeSearch(); });
    searchTrigger.addEventListener('click', openSearch);
  </script>
</body>
</html>
