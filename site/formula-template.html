<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{FORMULA_NAME}} - Homebrew Den</title>
  <meta name="description" content="Install {{FORMULA_NAME}} from the Homebrew Den tap.">
  <link rel="icon" type="image/svg+xml" href="../../favicon.svg">
  <link rel="stylesheet" href="../../styles.css">
</head>
<body>
  <!-- Nav -->
  <nav class="nav">
    <div class="nav-inner">
      <a href="../../" class="nav-brand">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M17 8h1a4 4 0 1 1 0 8h-1"/>
          <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/>
          <line x1="6" y1="2" x2="6" y2="4"/>
          <line x1="10" y1="2" x2="10" y2="4"/>
          <line x1="14" y1="2" x2="14" y2="4"/>
        </svg>
        Homebrew Den
      </a>
      <div class="nav-actions">
        <button class="search-trigger" id="search-trigger" aria-label="Search packages">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
          <span class="search-trigger-text">Search packages...</span>
          <kbd class="search-kbd"></kbd>
        </button>
        <button class="nav-btn" id="theme-toggle" aria-label="Toggle theme">
          <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
          <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        </button>
        <a href="https://github.com/mrdemonwolf/homebrew-den" class="nav-btn" aria-label="View on GitHub" target="_blank" rel="noopener noreferrer">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/>
          </svg>
        </a>
      </div>
    </div>
  </nav>

  <!-- Search Modal -->
  <div class="search-overlay hidden" id="search-overlay">
    <div class="search-modal">
      <div class="search-input-wrap">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input type="text" class="search-input" id="search-input" placeholder="Search formulae and casks..." autocomplete="off" spellcheck="false">
        <kbd class="search-esc">esc</kbd>
      </div>
      <div class="search-results" id="search-results">
        <div class="search-empty">Type to search packages...</div>
      </div>
      <div class="search-footer">
        <span><kbd>&uarr;</kbd><kbd>&darr;</kbd> navigate</span>
        <span><kbd>&crarr;</kbd> open</span>
        <span><kbd>esc</kbd> close</span>
      </div>
    </div>
  </div>

  <!-- Breadcrumb -->
  <div class="breadcrumb-bar">
    <div class="breadcrumb-inner">
      <a href="../../">Home</a>
      <span class="breadcrumb-sep">/</span>
      <a href="../../#formulae-section">Formulae</a>
      <span class="breadcrumb-sep">/</span>
      <span id="breadcrumb-name">{{FORMULA_NAME}}</span>
    </div>
  </div>

  <!-- Formula Detail -->
  <main class="section formula-detail">
    <div class="formula-header">
      <div class="formula-title-row">
        <h1 class="formula-name" id="formula-name"></h1>
        <span class="pkg-version formula-version" id="formula-version"></span>
      </div>
      <p class="formula-desc" id="formula-desc"></p>
    </div>

    <!-- Install Command -->
    <div class="formula-card">
      <h2 class="formula-card-title">Install</h2>
      <div class="install-box formula-install-box">
        <code id="install-command"></code>
        <button class="copy-btn" onclick="copyText('install-command', this)" aria-label="Copy install command">
          <svg class="icon-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
          </svg>
          <svg class="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Details -->
    <div class="formula-card">
      <h2 class="formula-card-title">Details</h2>
      <dl class="formula-meta">
        <div class="formula-meta-row">
          <dt>Homepage</dt>
          <dd><a id="formula-homepage" href="" target="_blank" rel="noopener noreferrer"></a></dd>
        </div>
        <div class="formula-meta-row">
          <dt>License</dt>
          <dd id="formula-license"></dd>
        </div>
        <div class="formula-meta-row">
          <dt>Version</dt>
          <dd id="formula-version-detail"></dd>
        </div>
      </dl>
    </div>

    <!-- Caveats -->
    <div class="formula-card hidden" id="caveats-card">
      <h2 class="formula-card-title">Caveats</h2>
      <pre class="formula-caveats" id="formula-caveats"></pre>
    </div>

    <!-- README -->
    <div class="formula-card" id="readme-card">
      <h2 class="formula-card-title">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 6px;">
          <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
          <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
        </svg>
        README
      </h2>
      <div class="readme-content" id="readme-content">{{README_HTML}}</div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-inner">
      <span>MIT License</span>
      <span class="footer-sep">&middot;</span>
      <span>&copy; 2026 <a href="https://www.mrdemonwolf.com" target="_blank" rel="noopener noreferrer">MrDemonWolf, Inc.</a></span>
      <span class="footer-sep">&middot;</span>
      <a href="https://github.com/mrdemonwolf/homebrew-den" target="_blank" rel="noopener noreferrer">GitHub</a>
    </div>
  </footer>

  <script>
    // --- Formula data injected at build time ---
    const formula = {{FORMULA_JSON}};
    const data = {{PACKAGES_JSON}};

    // --- Populate page ---
    document.getElementById('formula-name').textContent = formula.name;
    document.getElementById('formula-version').textContent = 'v' + formula.version;
    document.getElementById('formula-desc').textContent = formula.desc;
    document.getElementById('install-command').textContent = 'brew install ' + formula.name;
    document.getElementById('formula-homepage').textContent = formula.homepage;
    document.getElementById('formula-homepage').href = formula.homepage;
    document.getElementById('formula-license').textContent = formula.license || 'N/A';
    document.getElementById('formula-version-detail').textContent = formula.version;

    if (formula.caveats) {
      document.getElementById('caveats-card').classList.remove('hidden');
      document.getElementById('formula-caveats').textContent = formula.caveats;
    }

    // Hide README card if empty
    const readmeContent = document.getElementById('readme-content');
    if (!readmeContent.innerHTML.trim()) {
      document.getElementById('readme-card').classList.add('hidden');
    }

    // --- Copy function ---
    function copyText(elementId, btn) {
      const text = document.getElementById(elementId).textContent;
      navigator.clipboard.writeText(text).then(() => {
        btn.classList.add('copied');
        btn.querySelector('.icon-copy').style.display = 'none';
        btn.querySelector('.icon-check').style.display = 'block';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.querySelector('.icon-copy').style.display = '';
          btn.querySelector('.icon-check').style.display = 'none';
        }, 2000);
      });
    }

    // --- Theme toggle ---
    const themeToggle = document.getElementById('theme-toggle');
    const html = document.documentElement;

    function setTheme(theme) {
      html.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const sun = themeToggle.querySelector('.icon-sun');
      const moon = themeToggle.querySelector('.icon-moon');
      if (theme === 'dark') {
        sun.style.display = 'block';
        moon.style.display = 'none';
      } else {
        sun.style.display = 'none';
        moon.style.display = 'block';
      }
    }

    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      setTheme(savedTheme);
    } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
      setTheme('light');
    } else {
      setTheme('dark');
    }

    themeToggle.addEventListener('click', () => {
      const current = html.getAttribute('data-theme');
      setTheme(current === 'dark' ? 'light' : 'dark');
    });

    // --- Cmd+K Search ---
    const searchOverlay = document.getElementById('search-overlay');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const searchTrigger = document.getElementById('search-trigger');
    let activeIndex = -1;

    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
    document.querySelector('.search-kbd').textContent = isMac ? '\u2318K' : 'Ctrl+K';

    function buildSearchIndex() {
      const items = [];
      (data.formulae || []).forEach(f => {
        items.push({ name: f.name, desc: f.desc, version: f.version, type: 'Formula', href: '../../formulae/' + f.name + '/' });
      });
      (data.casks || []).forEach(c => {
        items.push({ name: c.name, desc: c.desc, version: c.version, type: 'Cask', href: c.homepage });
      });
      return items;
    }

    const searchIndex = buildSearchIndex();

    function openSearch() {
      searchOverlay.classList.remove('hidden');
      searchInput.value = '';
      searchInput.focus();
      activeIndex = -1;
      renderSearchResults('');
      document.body.style.overflow = 'hidden';
    }

    function closeSearch() {
      searchOverlay.classList.add('hidden');
      document.body.style.overflow = '';
    }

    function renderSearchResults(query) {
      if (!query.trim()) {
        searchResults.innerHTML = '<div class="search-empty">Type to search packages...</div>';
        activeIndex = -1;
        return;
      }

      const q = query.toLowerCase();
      const matches = searchIndex.filter(item =>
        item.name.toLowerCase().includes(q) ||
        item.desc.toLowerCase().includes(q)
      );

      if (matches.length === 0) {
        searchResults.innerHTML = '<div class="search-empty">No packages found.</div>';
        activeIndex = -1;
        return;
      }

      searchResults.innerHTML = matches.map((item, i) => `
        <a href="${item.href}" class="search-result${i === activeIndex ? ' active' : ''}" data-index="${i}">
          <div class="search-result-left">
            <span class="search-result-name">${item.name}</span>
            <span class="search-result-desc">${item.desc}</span>
          </div>
          <div class="search-result-right">
            <span class="search-result-badge">${item.type}</span>
            <span class="search-result-version">v${item.version}</span>
          </div>
        </a>
      `).join('');
    }

    function navigateResults(direction) {
      const items = searchResults.querySelectorAll('.search-result');
      if (items.length === 0) return;
      activeIndex += direction;
      if (activeIndex < 0) activeIndex = items.length - 1;
      if (activeIndex >= items.length) activeIndex = 0;
      items.forEach((el, i) => el.classList.toggle('active', i === activeIndex));
      items[activeIndex].scrollIntoView({ block: 'nearest' });
    }

    function selectResult() {
      const items = searchResults.querySelectorAll('.search-result');
      if (activeIndex >= 0 && activeIndex < items.length) items[activeIndex].click();
    }

    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        searchOverlay.classList.contains('hidden') ? openSearch() : closeSearch();
      }
      if (e.key === 'Escape' && !searchOverlay.classList.contains('hidden')) closeSearch();
    });

    searchInput.addEventListener('input', () => { activeIndex = -1; renderSearchResults(searchInput.value); });
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowDown') { e.preventDefault(); navigateResults(1); }
      if (e.key === 'ArrowUp') { e.preventDefault(); navigateResults(-1); }
      if (e.key === 'Enter') { e.preventDefault(); selectResult(); }
    });

    searchOverlay.addEventListener('click', (e) => { if (e.target === searchOverlay) closeSearch(); });
    searchTrigger.addEventListener('click', openSearch);
  </script>
</body>
</html>
